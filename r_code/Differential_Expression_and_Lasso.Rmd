---
title: 'Normalize Counts and Merge in '
author: "Jenny Smith"
date: "February 4, 2018"
output: html_document
---


#Set-up 

```{r setup}
library(knitr)
knitr::opts_chunk$set(tidy.opts=list(width.cutoff=50),tidy=TRUE, fig.align='center', fig.height=5, fig.width=8, dpi = 600)
knitr::opts_knit$set(root.dir = '~/Documents/GitHub/RNAseq_Cancer_Biomarkers/')
options(stringsAsFactors = FALSE)
```


```{r message = FALSE, warning=FALSE}
library(stringr)
library(magrittr)
library(ggplot2)
library(dplyr)
library(tibble)
library(tidyr)
getwd()
```


#Read in Counts 

```{r}
counts <- read.csv("TARGET_NBL_AML_RT_WT_HTSeq_Counts.csv",row.names = 1)

head(counts[,1:5])
dim(counts)
```


#Use the Merged Clinical and TMMCPM 

This was created by David Lee Using Python()
See D-V-DLee for Github 

```{r}
AML.CDE <- read.csv("Clinical_Data/AML_assay_clinical.csv", row.names = 1) 

dim(AML.CDE)
head(AML.CDE[,1:5])

getwd()
```

```{r}
table(AML.CDE$Diagnostic.ID)
```

```{r}
NBL.CDE <- read.csv("Clinical_Data/NBL_assay_clinical.csv", row.names = 1)

dim(NBL.CDE)
head(NBL.CDE[,1:5])
```

```{r}
table(NBL.CDE$Diagnostic.ID)
```

```{r}
WT.CDE <- read.csv("Clinical_Data/WT_assay_clinical.csv", row.names = 1)

dim(WT.CDE)
head(WT.CDE[,1:5])
```

```{r}
table(WT.CDE$Diagnostic.ID)
```

Remove Non-diagnostic samples: 04A, 40A, 02A, 06A, 11A


#Examine and Clean Clinical Data Elements

```{r}
cols.AML <- colnames(AML.CDE) %>% grep("^ENSG", ., invert=T, value=T)

# cols.AML


```

```{r}
AML.CDE.s <- AML.CDE %>%
  #filter out non-diagnostic samples for now
  filter(! grepl( "04A|40A|02A|06A|11A", Diagnostic.ID)) %>% 
  mutate_at(vars(c(45:47)), funs(gsub("NO", "No", .))) %>%
  set_rownames(.$TARGET.USI)


dim(AML.CDE.s)
head(AML.CDE.s[,1:5])
```




#Define a Training and Testing Set 


```{r}
set.seed(2019)
AML.train <- sample(AML.CDE.s$TARGET.USI, size = nrow(AML.CDE.s)*(2/3),replace = FALSE)

length(AML.train)
head(AML.train)

# write.csv(AML.train, "r_code/TARGET_AML_Training_Samples.csv")
```


```{r}
AML.test <- AML.CDE.s$TARGET.USI[!AML.CDE.s$TARGET.USI %in% AML.train]

head(AML.test)
length(AML.test)

write.csv(AML.test, "r_code/TARGET_AML_Testing_Samples.csv")
```

```{r}
sapply(AML.CDE.s[,c(21:35,45:47)], table)
```

Split median Age (ref == young (0))
Split on High+std vs Low (ref)



```{r}
#remove any patient samples that are not diagnositic
Keep <- colnames(counts) %>% grep("04A|40A|02A|06A|11A", ., invert=TRUE, value=TRUE) 

#remove end of the barcodes to match Clinical Data Rows 
newColnames <- Keep %>%  gsub("\\.0[0-9]A.+","" ,.) 

#Subset the raw counts for diagnostic samples and rename columns
counts.sub <- counts[,Keep]
colnames(counts.sub) <- newColnames

head(counts.sub[,1:5])
dim(counts.sub) #60,488 by 407 samples
```




#Differential Expression Analysis


```{r}
source("r_code/Limma_Voom_DE_Function.R")
```


```{r}
#There are duplicate 
pheno <- AML.CDE$WT1.mutation %>% 
  set_names(gsub("-",".",AML.CDE$TARGET.USI)) %>% 
  .[.!="Unknown"]


pheno <- 

head(pheno)
length(pheno)
table(pheno)
```


```{r}
DE.WT1 <- voom_DE(counts.df = counts.sub, ref="No",pheno=pheno)
```


```{r}
DE.WT1$desingMatrix[1:5,]

table(DE.WT1$desingMatrix[,1])
```





Deliverables
1. notebook/script
2. significance of findings






---
title: 'Normalize Counts and Merge in '
author: "Jenny Smith"
date: "February 4, 2018"
output: html_document
---


#Set-up 

```{r setup}
library(knitr)
knitr::opts_chunk$set(tidy.opts=list(width.cutoff=50),tidy=TRUE, fig.align='center', fig.height=5, fig.width=8, dpi = 600)
knitr::opts_knit$set(root.dir = '~/Documents/GitHub/RNAseq_Cancer_Biomarkers/')
options(stringsAsFactors = FALSE)
```


```{r message = FALSE, warning=FALSE}
library(stringr)
library(magrittr)
library(ggplot2)
library(dplyr)
library(tibble)
library(tidyr)
getwd()
```


#Read in Counts 

```{r}
counts <- read.csv("TARGET_NBL_AML_RT_WT_HTSeq_Counts.csv",row.names = 1)

head(counts[,1:5])
dim(counts)
```


#Use the Merged Clinical and TMMCPM 

This was created by David Lee Using Python()
See D-V-DLee for Github 

```{r}
AML.CDE <- read.csv("Clinical_Data/AML_assay_clinical.csv", row.names = 1) 

dim(AML.CDE)
head(AML.CDE[,1:5])

getwd()
```

```{r}
table(AML.CDE$Diagnostic.ID)
```

```{r}
NBL.CDE <- read.csv("Clinical_Data/NBL_assay_clinical.csv", row.names = 1)

dim(NBL.CDE)
head(NBL.CDE[,1:5])
```

```{r}
table(NBL.CDE$Diagnostic.ID)
```

```{r}
WT.CDE <- read.csv("Clinical_Data/WT_assay_clinical.csv", row.names = 1)

dim(WT.CDE)
head(WT.CDE[,1:5])
```

```{r}
table(WT.CDE$Diagnostic.ID)
```

Remove Non-diagnostic samples: 04A, 40A, 02A, 06A, 11A


#Examine and Clean Clinical Data Elements

```{r}
cols.AML <- colnames(AML.CDE) %>% grep("^ENSG", ., invert=T, value=T)

# cols.AML


```

```{r}
AML.CDE.s <- AML.CDE %>%
  #filter out non-diagnostic samples for now
  filter(! grepl( "04A|40A|02A|06A|11A", Diagnostic.ID)) %>% 
  mutate_at(vars(c(45:47)), funs(gsub("NO", "No", .))) %>%
  set_rownames(.$TARGET.USI)


dim(AML.CDE.s)
head(AML.CDE.s[,1:5])
```




#Define a Training and Testing Set 


```{r}
set.seed(2019)
AML.train <- sample(AML.CDE.s$TARGET.USI, size = nrow(AML.CDE.s)*(2/3),replace = FALSE) %>% 
  gsub("-",".", .)

length(AML.train)
head(AML.train)

# write.csv(AML.train, "r_code/TARGET_AML_Training_Samples.csv")
```
 "TARGET.20.PASFEW" "TARGET.20.PARYFN" "TARGET.20.PANSBH" "TARGET.20.PARPDS" "TARGET.20.PAEIKD"
[6] "TARGET.20.PAEFGT"

```{r}
AML.test <- AML.CDE.s$TARGET.USI[!AML.CDE.s$TARGET.USI %in% AML.train] %>% 
    gsub("-",".", .)

head(AML.test)
length(AML.test)

# write.csv(AML.test, "r_code/TARGET_AML_Testing_Samples.csv")
```

[1] "TARGET.20.PADYIR" "TARGET.20.PADZCG" "TARGET.20.PAEAKL" "TARGET.20.PAECCE" "TARGET.20.PAEERJ"
[6] "TARGET.20.PAEFGR"


```{r}
CDE.train <- AML.CDE.s %>%
  mutate_at(vars(TARGET.USI), funs(gsub("-",".", .))) %>% 
  filter(TARGET.USI %in% AML.train) %>% 
  mutate(RiskGroup.Class=case_when(
    grepl("High|Standard", Risk.group) ~ "Yes", 
    grepl("Low", Risk.group) ~ "No", 
    grepl("Unknown", Risk.group) ~ "Unknown" )) %>% 
  mutate(Age.Class=ifelse(Age.at.Diagnosis.in.Days > median(Age.at.Diagnosis.in.Days), "Yes", "No"))

dim(CDE.train)

table(CDE.train$Risk.group)
table(CDE.train$RiskGroup.Class)
table(CDE.train$Age.Class)
```



#Split the Expression Data into Train/Test


```{r}
#remove any patient samples that are not diagnositic
Keep <- colnames(counts) %>% 
  grep("04A|40A|02A|06A|11A", ., invert=TRUE, value=TRUE) %>% 
  grep("TARGET.20", ., value=TRUE)

#remove end of the barcodes to match Clinical Data Rows 
newColnames <- Keep %>%  gsub("\\.0[0-9]A.+","" ,.) 


#Subset the raw counts for diagnostic samples and rename columns
counts.sub <- counts[,Keep]
colnames(counts.sub) <- newColnames
dim(counts.sub) #60,488 by 145 samples
```

```{r}
#Select Training Set
counts.train <- counts.sub[,AML.train]

dim(counts.train)
```



#Differential Expression Analysis

Split median Age (ref == young (0))
Split on High+std vs Low (ref)


```{r}
source("r_code/Limma_Voom_DE_Function.R")
```

```{r}
pheno <- CDE.train$RiskGroup.Class %>% 
  set_names(CDE.train$TARGET.USI) %>%
  .[.!="Unknown"]

head(pheno)
length(pheno)
table(pheno)
```


```{r}
DE.RG <- voom_DE(counts.df = counts.sub, ref="No",pheno=pheno)
```


```{r}
DE.RG$desingMatrix[1:5,]
table(DE.RG$desingMatrix[,1])
dim(DE.RG$voomTransformation$E) #17445    93
```

```{r}
CDE.train %>% 
  select( "RiskGroup.Class")
  filter(TARGET.USI %in% rownames(DE.RG$desingMatrix[1:5,])) %>%
 
```

```{r}
head(DE.RG$DEGs)
dim(DE.RG$DEGs)

# write.csv(DE.RG$DEGs, "r_code/TARGET_AML_High.Std.Risk_vs_LowRisk_DEGs.csv")
```


```{r}
pheno2 <- CDE.train$Age.Class %>% 
  set_names(CDE.train$TARGET.USI) %>%
  .[.!="Unknown"]

head(pheno2)
length(pheno2)
table(pheno2)
```


```{r}
DE.Age <- voom_DE(counts.df = counts.sub, ref="No",pheno=pheno2)
```


```{r}
head(DE.Age$DEGs)

write.csv(DE.Age$DEGs, "r_code/TARGET_AML_Older_vs_Younger_by_MedianAge_DEGs.csv")
```


Deliverables
1. notebook/script
2. significance of findings


#Lasso with DEGs

There is not too much class imbalance on either 

```{r}
 
```










